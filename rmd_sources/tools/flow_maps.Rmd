---
title: "Flow maps"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
libs <- c("readr", "dplyr", "rnaturalearth", "rnaturalearthdata", "sf", "stringr", "gganimate")

installed_libs <- libs %in% rownames(installed.packages())
if (any(installed_libs == FALSE)) {
    install.packages(libs[!installed_libs])
}
invisible(lapply(libs, library, character.only = TRUE))
colours <- c("#00559D", "#AA7147")
```

## Import flow data

```{r load_data}
load_counts <- function(file) {
  types <- cols(col_character(), col_integer())
  counts <- read_csv(paste0("..\\..\\data\\tools\\flow_maps\\", file), col_types = types)
  counts
}

birth_counts <- load_counts("birth_counts.csv")
travel_counts <- load_counts("travel_counts.csv")
```

## Mapping

```{r cache = TRUE}
world_map_base_data_gen = function(country_name_adjust = c("Czech Republic" = "Czech Republic")) {
  data_out <- ne_countries(scale = "medium", returnclass = "sf") %>%
    filter(sovereignt != "Antarctica") %>%
    select(name_long, formal_en, pop_est, pop_rank, pop_year, gdp_md, gdp_year,
           economy, income_grp, region_un, subregion, region_wb, label_x,
           label_y, wikidataid, geometry)
  names(data_out)[1] <- "Country"

  data_out <- data_out %>%
  st_transform("ESRI:54030") %>%
  mutate(
    Country = str_replace_all(Country, country_name_adjust)
  )
  data_out
}

world_map_base_data <- world_map_base_data_gen(country_name_adjust = c(
  "Czech Republic" = "Czechia",
  "CÃ´te d'Ivoire" = "Cote d'Ivoire",
  "Democratic Republic of the Congo" = "Democratic Republic of Congo",
  "Kingdom of eSwatini" = "Eswatini",
  "Lao PDR" = "Laos",
  "Republic of the Congo" = "Congo",
  "Syria" = "Syrian Arab Republic",
  "The Gambia" = "Gambia"
))
```

```{r}
world_base_map = function(title_in = "Base map", caption_in = "Base caption") {
  world_base_map <- ggplot(world_map_base_data) + geom_sf(lwd = 0.3, colour = "white") +
    labs(title = element_blank(), x = element_blank(), y = element_blank()) +
    lims(y = c(-6000000,7800000)) + # TODO convert limits to degrees?
    theme_void(base_size = 24) +
    theme(
      legend.title = element_text(size = 21, colour = colours[1]),
      legend.margin = margin(c(0,0,0,0)),
      legend.position.inside = c(0.2, 0.3),
      legend.key.size = unit(25, "points"),
      axis.text.y = element_blank(), axis.text.x = element_blank(),
      axis.ticks.y = element_blank(), axis.ticks.x = element_blank(),
      text = element_text(colour = colours[1])
    )
  world_base_map
}
```

# Generate matrix representing frequency of two countries mentioned

```{r}
# TODO find a cleaner way of generating travel_combs without duplicates
travel_combs <- expand.grid(x = travel_counts$Country, y = travel_counts$Country) %>% filter(x != y)
```

```{r}
get_country_coords <- function(country_name) {
  cent <- world_map_base_data %>% filter(Country == country_name) %>% st_geometry() %>% st_centroid()
  coords <- st_coordinates(cent)
  coords
}
```

```{r, fig.width=14}
world_base_map() +
  geom_point(data = get_country_coords("Albania"), aes(x=X, y=Y)) +
  geom_point(data = get_country_coords("Algeria"), aes(x=X, y=Y)) +
  geom_curve(data = data.frame(), lineend = "round", aes(
    x = get_country_coords("Albania")[1], y = get_country_coords("Albania")[2],
    xend = get_country_coords("Algeria")[1], yend = get_country_coords("Algeria")[2],
    linewidth = travel_matrix["Albania", "Algeria"], alpha = 0.2)
  ) + theme(legend.position = "none")
```

***

[Orbits!](../index.html)
